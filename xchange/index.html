<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contact Exchange PWA</title>

  <!-- UIKit CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.17.13/dist/css/uikit.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.13/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.13/dist/js/uikit-icons.min.js"></script>

  <!-- QR libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    #reader {
      width: 100%;
      height: 300px;
      background: #000;
    }

    .contact-card {
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    #qrcode {
      text-align: center;
      padding: 1rem;
    }

    canvas {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- Scanner -->
  <div id="reader"></div>

  <!-- Contact List -->
  <div class="uk-container uk-padding-small">
    <h3 class="uk-heading-line"><span>My Contacts</span></h3>
    <div id="contact-list">Loading contacts...</div>
  </div>

  <!-- QR Code -->
  <div id="qrcode">
    <h4 class="uk-text-center">My Contact QR</h4>
    <div id="myqrcode"></div>
  </div>

  <script>
    const myContact = {
      name: "Zapanta Lawod",
      email: "zapantalawod@gmail.com",
      phone: "+0987 2446789",
      website: "https://zapantalawod.com",
      map: "Zapanta Lawod Office, Cebu City"
    };

    // Generate QR Code using QRCode.js (NOT qrcode.toCanvas)
    new QRCode(document.getElementById("myqrcode"), {
      text: JSON.stringify(myContact),
      width: 200,
      height: 200,
      colorDark: "#000",
      colorLight: "#fff",
      correctLevel: QRCode.CorrectLevel.H
    });

    // QR Scanner logic
    const onScanSuccess = async (decodedText) => {
      try {
        const contact = JSON.parse(decodedText);
        await localforage.setItem("contact-" + contact.name, contact);
        UIkit.notification(`Contact saved: ${contact.name}`, "success");
        listAllContacts();
      } catch (e) {
        UIkit.notification("Invalid QR Code", "danger");
      }
    };

    new Html5Qrcode("reader").start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess
    );

    // Show contacts
    async function listAllContacts() {
      const keys = await localforage.keys();
      const contacts = await Promise.all(
        keys.filter(k => k.startsWith("contact-")).map(k => localforage.getItem(k))
      );

      const container = document.getElementById("contact-list");
      if (contacts.length === 0) {
        container.innerHTML = "<p>No contacts yet.</p>";
        return;
      }

      container.innerHTML = contacts.map(c => `
        <div class="contact-card uk-card uk-card-default uk-card-body" data-name="${c.name}">
          <h4 class="uk-card-title">${c.name}</h4>
          <p><span uk-icon="mail"></span> <a href="mailto:${c.email}">${c.email}</a></p>
          <p><span uk-icon="phone"></span> <a href="tel:${c.phone}">${c.phone}</a></p>
          <p><span uk-icon="link"></span> <a href="${c.website}" target="_blank">${c.website}</a></p>
          <p><span uk-icon="location"></span> <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.map)}" target="_blank">Google Maps</a></p>
          <button class="uk-button uk-button-danger uk-button-small" onclick="deleteContact('${c.name}')">
            <span uk-icon="trash"></span> Delete
          </button>
        </div>
      `).join("");
    }

    // Delete contact
    async function deleteContact(name) {
      await localforage.removeItem("contact-" + name);
      UIkit.notification(`Deleted: ${name}`, "primary");
      listAllContacts();
    }

    listAllContacts();
  </script>
</body>
</html>
