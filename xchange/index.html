<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contact Exchange PWA</title>

  <!-- UIkit CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.17.13/dist/css/uikit.min.css" />

  <!-- UIkit JS -->
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.13/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.13/dist/js/uikit-icons.min.js"></script>

  <!-- QR Code + Scanner + LocalForage -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    #reader {
      width: 100%;
      max-width: 100%;
      height: 300px;
      background: #000;
    }

    .contact-card {
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    #qrcode {
      padding: 1rem;
      text-align: center;
      border-top: 1px solid #ccc;
      background: #fafafa;
    }
  </style>
</head>
<body>

  <!-- QR Code Scanner -->
  <div id="reader"></div>

  <!-- Contact List -->
  <div class="uk-container uk-padding-small">
    <h3 class="uk-heading-line"><span>My Contacts</span></h3>
    <div id="contact-list">Loading contacts...</div>
  </div>

  <!-- My Contact QR Code -->
  <div id="qrcode"></div>

  <script>
    const myContact = {
      name: "Zapanta Lawod",
      email: "zapantalawod@gmail.com",
      phone: "+0987 2446789",
      website: "https://zapantalawod.com",
      map: "Zapanta Lawod Office, Cebu City"
    };

    // Generate My QR Code
    QRCode.toCanvas(JSON.stringify(myContact), { width: 200 }, (err, canvas) => {
      if (!err) {
        document.getElementById("qrcode").innerHTML = `
          <h4 class="uk-text-center">My Contact QR</h4>
        `;
        document.getElementById("qrcode").appendChild(canvas);
      }
    });

    // QR Scanner Success Handler
    const onScanSuccess = async (decodedText) => {
      try {
        const contact = JSON.parse(decodedText);
        await localforage.setItem("contact-" + contact.name, contact);
        UIkit.notification(`Contact saved: ${contact.name}`, "success");
        listAllContacts();
      } catch (e) {
        UIkit.notification("Invalid QR Code", "danger");
      }
    };

    new Html5Qrcode("reader").start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      onScanSuccess
    );

    // Display Contact Cards
    async function listAllContacts() {
      const keys = await localforage.keys();
      const contacts = await Promise.all(
        keys.filter(k => k.startsWith("contact-")).map(k => localforage.getItem(k))
      );

      const container = document.getElementById("contact-list");
      if (contacts.length === 0) {
        container.innerHTML = "<p>No contacts yet.</p>";
        return;
      }

      container.innerHTML = contacts.map(c => `
        <div class="contact-card uk-card uk-card-default uk-card-body" data-name="${c.name}">
          <h4 class="uk-card-title">${c.name}</h4>
          <p><span uk-icon="icon: mail"></span> <a href="mailto:${c.email}">${c.email}</a></p>
          <p><span uk-icon="icon: phone"></span> <a href="tel:${c.phone}">${c.phone}</a></p>
          <p><span uk-icon="icon: link"></span> <a href="${c.website}" target="_blank">${c.website}</a></p>
          <p><span uk-icon="icon: location"></span> <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.map)}" target="_blank">Google Maps</a></p>
          <button class="uk-button uk-button-danger uk-button-small" onclick="deleteContact('${c.name}')">
            <span uk-icon="icon: trash"></span> Delete
          </button>
        </div>
      `).join("");
    }

    // Delete Contact
    async function deleteContact(name) {
      await localforage.removeItem("contact-" + name);
      UIkit.notification(`Deleted: ${name}`, "primary");
      listAllContacts();
    }

    // Load contacts on startup
    listAllContacts();
  </script>
</body>
</html>
